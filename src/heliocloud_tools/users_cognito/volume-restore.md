# Restoring user volumes in bulk

### This directory contains two key scripts used in restoring user volumes: [`restore-user-volumes.py`](./resore-user-volumes.py) and [`make-pv-pvc.py`](./make-pv-pvc.py)

## restore-user-volumes.py
### We start the process with this script, it takes in a CSV with the following data:
`UserName,VolumeID,SnapID,OldPVC,NewPVC`

The script then generates user volumes and displays the newly created volume IDs in the following format:

```
Creating Volume for: UserName
UserName,NewVolumeID
```

You need to capture the input of this script, so we suggest running it with `tee` after that it needs some processing to remove the unneccessary lines and to check for any failures or errors and note down which users were affected.

After the volumes are generated, you can then use `make-pv-pvc.py` to proceed.


## make-pv-pvc.py
### Using the generated `userName,volumeID` csv generated by the previous script:

This script generates the PV and PVC claims for the user volumes with the new volume ID restored from the given snapshot in the previous step.

You _**must**_ delete any old PV and PVC claims since the `VolumeID` field is immutable after creation and you must generate a new one.

The script will generate a directory of the PVs and PVCs which you can then run using the following snippet/script:

### NOTE: Must run with `bash` and not `sh`
```bash
#!/bin/bash

echo "Applying PVs"

for pv_file in *_pv.yaml; do
  echo "Applying $pv_file"
  kubectl apply -f "$pv_file"
done

echo "All PVs applied"

echo "Applying PVCs"
for pvc_file in *_pvc.yaml; do
  echo "Applying $pvc_file"
  kubectl apply -f "$pvc_file"
done

echo "All PVCs applied"
```
